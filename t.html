<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Triangle Fraternity ‚Äî NFC Welcome Card (no-cache, single file) -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welcome, Sophia! ‚Äî Triangle Fraternity</title>
  <meta name="description" content="A welcoming, playful NFC card for a Triangle guest." />
  <meta name="theme-color" content="#C85A5A" />

  <!-- No-cache (client-side best effort) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    /* ===== Theme (Triangle-inspired): Old Rose + Slate ===== */
    :root{
      --rose:#C85A5A; --rose-200:#f6dada;
      --slate-25:#0c0d10; --slate-100:#1A1C24; --slate-600:#6C7486;
      --radius:18px; --shadow-dark:0 12px 32px rgba(0,0,0,.35); --shadow-light:0 10px 25px rgba(0,0,0,.08);
    }
    :root{ /* default dark */
      --bg:var(--slate-25); --card:var(--slate-100); --text:#F4F6FA; --muted:#ACB2C0; --line:rgba(255,255,255,.14); --shadow:var(--shadow-dark);
      color-scheme: dark;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#FAFBFF; --card:#FFFFFF; --text:#10131A; --muted:#5B6272; --line:#E7E9F0; --shadow:var(--shadow-light); color-scheme: light; }
    }
    [data-theme="dark"]{ --bg:#0c0d10; --card:#1A1C24; --text:#F4F6FA; --muted:#ACB2C0; --line:rgba(255,255,255,.14); --shadow:var(--shadow-dark); color-scheme: dark;}
    [data-theme="light"]{ --bg:#FAFBFF; --card:#FFFFFF; --text:#10131A; --muted:#5B6272; --line:#E7E9F0; --shadow:var(--shadow-light); color-scheme: light;}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:var(--bg); color:var(--text); display:flex; flex-direction:column;
    }

    .wrap{max-width:940px; margin:0 auto; width:100%}
    header, footer{padding:16px}
    header .inner, footer .inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    footer .inner{justify-content:center; opacity:.9; font-size:.95rem}

    .brand{display:flex; align-items:center; gap:14px}
    .crest{height:72px; width:auto; display:block; object-fit:contain; filter: drop-shadow(0 3px 8px rgba(0,0,0,.25))}
    @media (max-width:520px){ .crest{ height:58px } }
    .ghost{background:transparent; border:1px solid var(--line); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer}

    main{flex:1}

    /* Hero */
    .hero{padding: clamp(24px, 6vw, 56px) 16px; display:grid; place-items:center}
    .hero-card{
      width:min(920px, 96%); text-align:center;
      background:linear-gradient(180deg, color-mix(in srgb, var(--rose-200), transparent 60%), transparent 100%), var(--card);
      border:1px solid var(--line); border-radius: clamp(16px, 3vw, 24px); box-shadow: var(--shadow);
      padding: clamp(18px, 4vw, 36px); display:grid; gap: clamp(12px, 2.5vw, 24px);
    }
    .hero-top{display:flex; align-items:center; justify-content:center; gap:14px; flex-wrap:wrap}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:color-mix(in srgb, var(--card), white 6%); font-weight:600}
    .chip .dot{width:8px; height:8px; border-radius:50%; background:var(--rose)}
    h1{font-size: clamp(1.8rem, 4.6vw, 3rem); margin:0}
    .lead{font-size: clamp(1.05rem, 2.3vw, 1.25rem); color:var(--muted); margin:0}

    /* Press & Hold */
    .hold-wrap{display:grid; place-items:center; margin:6px 0 0}
    .heart{
      width: clamp(140px, 26vw, 200px); height: clamp(140px, 26vw, 200px); border-radius: 28px;
      background: radial-gradient(120px 120px at 50% 50%, var(--rose), color-mix(in srgb, var(--rose), white 45%));
      display:grid; place-items:center; box-shadow:var(--shadow); position:relative; cursor:pointer;
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
    }
    .heart::before{ content:"‚ù§"; font-size: clamp(56px, 10vw, 80px); filter: drop-shadow(0 2px 4px rgba(0,0,0,.25)) }
    .ring{position:absolute; inset:10px; border-radius:24px; border:4px solid rgba(255,255,255,.85); clip-path: inset(0 round 24px); transform: scaleX(0); transform-origin:left; transition: transform .2s linear}
    .ring.fill{ transform: scaleX(1) }
    .hint{color:var(--muted); margin-top:6px}

    /* Step card */
    .step{padding: clamp(18px, 3.6vw, 28px) 16px 32px; display:grid; place-items:center}
    .panel{width:min(720px, 96%); background:var(--card); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: clamp(16px, 4vw, 28px); display:grid; gap:16px}
    .panel h2{margin:0; font-size: clamp(1.3rem, 3.6vw, 1.8rem)}
    .panel p{margin:0}

    /* Keypad & input */
    .keypad{display:grid; gap:12px}
    .dots{display:flex; justify-content:center; gap:10px; margin:4px 0 8px}
    .dot{width:14px; height:14px; border-radius:99px; border:2px solid var(--line); background:transparent}
    .dot.filled{ background: var(--rose); border-color: color-mix(in srgb, var(--rose), black 10%) }
    .codebox{display:flex; justify-content:center; gap:10px; margin:6px 0}
    .codebox input{
      width:56px; text-align:center; font-size:1.4rem; padding:10px 0;
      background:color-mix(in srgb, var(--card), white 6%); color:var(--text); border:1px solid var(--line); border-radius:12px;
    }
    @media (max-width:420px){ .codebox input{ width:50px } }
    .keys{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px}
    .keys button{
      padding: clamp(14px, 4vw, 18px) 0; border-radius:14px; border:1px solid var(--line);
      background: color-mix(in srgb, var(--card), white 6%); color:var(--text);
      font-size: clamp(1.2rem, 3.8vw, 1.5rem); cursor:pointer; font-weight:700;
    }
    @media (prefers-color-scheme: light){ .keys button{ background:#fff; color:#10131A } }
    .cta{ background:var(--rose); color:#fff; font-weight:800; border:0; border-radius:14px; padding:14px 16px; cursor:pointer; box-shadow: var(--shadow) }
    .cta:active{ transform: translateY(1px) }
    .form-msg{min-height:22px; font-size:.98rem}
    .form-msg.ok{color:#28c48b}
    .form-msg.err{color:#ff6b6b}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
    .secondary{background:transparent; color:var(--text); border:1px solid var(--line); padding:12px 14px; border-radius:12px; cursor:pointer}
    .accordion{display:grid; gap:8px}
    .accordion details{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; box-shadow:var(--shadow)}
    .accordion summary{cursor:pointer; font-weight:600}

    #confetti{width:100%; height:220px; display:block; border-radius:12px}

    .view{display:none}
    .view.active{display:block; animation:fade .25s ease}
    @keyframes fade { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
    .shake{animation:shake .2s linear}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header>
    <div class="wrap inner">
      <div class="brand">
        <!-- Put your crest here (URL or data URI). Leave empty if you don't want it -->
        <img class="crest" alt="Triangle Fraternity Crest" src="" />
        <strong>Triangle Fraternity</strong>
      </div>
      <button id="themeToggle" class="ghost" aria-label="Toggle theme">üåì</button>
    </div>
  </header>

  <main>
    <!-- ===== Hero / Welcome ===== -->
    <section class="hero view active" id="landing">
      <div class="hero-card">
        <div class="hero-top">
          <span class="chip"><span class="dot"></span> Welcome Weekend</span>
          <span class="chip">Guest: <strong>Sophia</strong></span>
        </div>

        <h1>Welcome, <span style="color:var(--rose); font-weight:800;">Sophia</span>! üéâ</h1>
        <p class="lead">We‚Äôre so happy you‚Äôre here. Ready to open your card?</p>

        <div class="hold-wrap">
          <div class="heart" id="holdHeart" role="button" aria-label="Press and hold to start">
            <div class="ring" id="holdRing"></div>
          </div>
          <p class="hint" id="holdHint">Press & hold the heart for 2 seconds.</p>
        </div>
      </div>
    </section>

    <!-- ===== Code Step ===== -->
    <section class="step view" id="step">
      <div class="panel">
        <h2>When was Penn State Triangle founded?</h2>
        <p class="lead">Enter the 4-digit year.</p>

        <!-- optional progress dots -->
        <div class="dots" id="dots">
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
        </div>

        <!-- visible 4 boxes + hidden aggregate input for keypad -->
        <div class="codebox" aria-hidden="true">
          <input id="d1" inputmode="numeric" maxlength="1" />
          <input id="d2" inputmode="numeric" maxlength="1" />
          <input id="d3" inputmode="numeric" maxlength="1" />
          <input id="d4" inputmode="numeric" maxlength="1" />
        </div>
        <input id="codeInput" type="password" inputmode="numeric" pattern="\\d{4}" maxlength="4" aria-label="Passcode" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />

        <form id="codeForm" class="keypad" autocomplete="off">
          <div class="keys" id="keys"></div>
          <button class="cta" type="submit">Unlock</button>
          <div class="form-msg" id="codeMsg" aria-live="polite"></div>
        </form>
      </div>
    </section>

    <!-- ===== Success ===== -->
    <section class="step view" id="success">
      <div class="panel">
        <canvas id="confetti" aria-hidden="true"></canvas>
        <h2>Welcome to the weekend, Sophia! ‚ú®</h2>
        <p class="lead">If you need directions, food recs, or a quick tour ‚Äî just say the word.</p>

        <div class="actions">
          <button class="secondary" id="tipsToggle">Weekend Tips</button>
          <button class="secondary" id="wifiCopy">Copy Wi-Fi</button>
          <button class="secondary" id="replay">Replay Confetti</button>
        </div>

        <div id="tips" class="accordion" hidden></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap inner">
      <span>Designed & built by <strong>Thomas Askharoun</strong></span>
    </div>
  </footer>

  <script>
    /* ==== Hard no-cache each visit ==== */
    (async () => {
      try {
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map(n => caches.delete(n)));
        }
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        window.addEventListener('pageshow', e => { if (e.persisted) location.reload(); });
      } catch {}
    })();

    /* Theme toggle */
    document.querySelector('#themeToggle').addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur === 'light' ? 'dark' : (cur === 'dark' ? '' : 'light');
      if (next) document.documentElement.setAttribute('data-theme', next);
      else document.documentElement.removeAttribute('data-theme');
    });

    /* Router helpers */
    function show(id){
      document.querySelectorAll('.view').forEach(v=>{
        const active = v.id === id;
        v.classList.toggle('active', active);
        v.setAttribute('aria-hidden', String(!active));
      });
      // every run is fresh ‚Äî no persistence
      try { sessionStorage.clear(); localStorage.clear(); } catch {}
    }

    /* Press & Hold start */
    (function(){
      const heart = document.getElementById('holdHeart');
      const ring  = document.getElementById('holdRing');
      const hint  = document.getElementById('holdHint');
      let timer=null, held=false;

      function begin(){
        if (held) return;
        ring.classList.add('fill');
        timer = setTimeout(()=>{
          held = true;
          hint.textContent = "Let‚Äôs do this ‚ú®";
          show('step');
        }, 2000);
      }
      function cancel(){
        ring.classList.remove('fill');
        if (timer){ clearTimeout(timer); timer=null; }
      }
      heart.addEventListener('pointerdown', e=>{ e.preventDefault(); begin(); });
      document.addEventListener('pointerup', cancel);
      document.addEventListener('pointercancel', cancel);
      heart.addEventListener('keydown', e=>{ if (e.key==='Enter' || e.key===' ') begin(); });
      heart.setAttribute('tabindex','0');
    })();

    /* Keypad + code logic (1928) ‚Äî robust & auto-submit at 4 digits */
    (function(){
      const PASS = "1928";
      const keysEl   = document.getElementById('keys');
      const form     = document.getElementById('codeForm');
      const input    = document.getElementById('codeInput'); // aggregate value
      const msg      = document.getElementById('codeMsg');
      const dots     = [...document.getElementById('dots').children];
      const boxes    = [document.getElementById('d1'),document.getElementById('d2'),document.getElementById('d3'),document.getElementById('d4')];

      // Build keypad
      const layout = ['1','2','3','4','5','6','7','8','9','‚Üê','0','OK'];
      layout.forEach(ch=>{
        const b=document.createElement('button');
        b.type = ch==='OK' ? 'submit' : 'button';
        b.textContent = ch;
        if (ch==='‚Üê') b.setAttribute('aria-label','Backspace');
        b.addEventListener('click', ()=>{
          if (ch==='OK') return;
          if (ch==='‚Üê'){ input.value = input.value.slice(0,-1); }
          else if (input.value.length < 4){ input.value += ch; }
          syncUI();
          if (input.value.length === 4) doSubmit(); // auto-submit
        });
        keysEl.appendChild(b);
      });

      // Desktop keyboard fallback: focus hidden input on load
      window.addEventListener('load', ()=> { input.focus(); });

      function syncUI(){
        // dots + boxes reflect current value
        const v = input.value;
        dots.forEach((d,i)=> d.classList.toggle('filled', i < v.length));
        boxes.forEach((bx,i)=> { bx.value = v[i] ? '‚Ä¢' : ''; });
        msg.textContent = '';
        msg.className = 'form-msg';
      }

      function doSubmit(){
        if (input.value === PASS){
          msg.textContent = 'Unlocked ‚úÖ'; msg.className = 'form-msg ok';
          setTimeout(()=> show('success'), 420);
          setTimeout(runConfetti, 520);
        } else {
          msg.textContent = 'Hint: the year PSU Triangle was founded.'; msg.className = 'form-msg err';
          input.classList.remove('shake'); void input.offsetWidth; input.classList.add('shake');
        }
      }

      form.addEventListener('submit', (e)=>{ e.preventDefault(); doSubmit(); });

      // keep UI in sync if user types on keyboard
      input.addEventListener('input', ()=>{ input.value = input.value.replace(/[^0-9]/g,'').slice(0,4); syncUI(); if (input.value.length===4) doSubmit(); });

      // init
      syncUI();
    })();

    /* Tips + Wi-Fi + Confetti */
    (function(){
      const tipsBtn = document.getElementById('tipsToggle');
      const tips    = document.getElementById('tips');
      const wifiBtn = document.getElementById('wifiCopy');
      const replay  = document.getElementById('replay');

      if (tipsBtn){
        const data = [
          {title:"Coffee", body:"Saint's Caf√© ‚Äî cozy & close."},
          {title:"Late night", body:"Canyon Pizza ‚Äî classic campus move."},
          {title:"Photo spot", body:"Old Main lawn at golden hour."}
        ];
        data.forEach(({title,body})=>{
          const d=document.createElement('details');
          const s=document.createElement('summary'); s.textContent=title;
          const p=document.createElement('p'); p.textContent=body;
          d.append(s,p); tips.appendChild(d);
        });
        tipsBtn.addEventListener('click', ()=>{
          tips.hidden = !tips.hidden;
          tipsBtn.setAttribute('aria-expanded', String(!tips.hidden));
        });
      }

      if (wifiBtn){
        wifiBtn.addEventListener('click', async ()=>{
          const SSID = "Triangle_House", PASS = "guest123";
          try{
            await navigator.clipboard.writeText(`${SSID} / ${PASS}`);
            wifiBtn.textContent = "Wi-Fi Copied ‚úÖ";
            setTimeout(()=> wifiBtn.textContent = "Copy Wi-Fi", 1400);
          }catch{
            alert(`Wi-Fi:\nSSID: ${SSID}\nPASS: ${PASS}`);
          }
        });
      }

      if (replay){ replay.addEventListener('click', runConfetti); }
    })();

    /* Confetti */
    function runConfetti(){
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      const DPR = Math.min(window.devicePixelRatio||1, 2);
      const W = canvas.width = canvas.offsetWidth * DPR;
      const H = canvas.height = 220 * DPR;
      const N = 160;
      const parts = Array.from({length:N}, ()=> ({
        x: Math.random()*W, y: Math.random()*-H,
        r: 2 + Math.random()*3,
        vx: -1 + Math.random()*2,
        vy: 1 + Math.random()*2.5,
        a: Math.random()*Math.PI*2
      }));
      const end = performance.now()+2500;
      (function tick(){
        ctx.clearRect(0,0,W,H);
        parts.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.a+=0.05;
          if (p.y>H){ p.y=-10; p.x=Math.random()*W; }
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle = Math.random()>.5 ? '#C85A5A' : '#ffffff';
          ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
          ctx.restore();
        });
        if (performance.now()<end) requestAnimationFrame(tick);
      })();
    }
  </script>
</body>
</html>
